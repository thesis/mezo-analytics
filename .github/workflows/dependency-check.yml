name: Dependency Security Check

on:
  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
  pull_request:
    paths:
      - 'requirements.txt'
      - '.github/workflows/dependency-check.yml'

jobs:
  security-check:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: ğŸ“¦ Install pip-audit
      run: |
        python -m pip install --upgrade pip
        pip install pip-audit

    - name: ğŸ” Run security audit
      run: |
        echo "ğŸ” Checking for known security vulnerabilities..."
        pip-audit --requirement requirements.txt --format=json --output=audit-results.json

    - name: ğŸ“Š Check for outdated packages
      run: |
        echo "ğŸ“Š Checking for outdated packages..."
        pip install -r requirements.txt
        pip list --outdated --format=json > outdated-packages.json

        # Display results
        echo "## ğŸ” Security Audit Results" >> $GITHUB_STEP_SUMMARY
        if [ -s audit-results.json ]; then
          echo "âš ï¸ Security vulnerabilities found - check audit-results.json" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… No security vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š Outdated Packages" >> $GITHUB_STEP_SUMMARY
        if [ "$(cat outdated-packages.json)" != "[]" ]; then
          echo "ğŸ“‹ The following packages have updates available:" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat outdated-packages.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… All packages are up to date" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ“ Upload audit results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-audit-${{ github.run_number }}
        path: |
          audit-results.json
          outdated-packages.json
        retention-days: 30
