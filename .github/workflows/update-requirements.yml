name: Update Requirements

on:
  schedule:
    # Run weekly on Sundays at 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: 3.13

jobs:
  update-requirements:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ Install current dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ” Run requirements updater script
      run: |
        echo "ðŸ”„ Running comprehensive requirements updater..."
        python scripts/update_requirements.py
        
    - name: ðŸ” Check for changes
      id: check_changes
      run: |
        # Check if git detects any changes to requirements.txt
        if git diff --quiet requirements.txt; then
            echo "No changes detected in requirements.txt"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
        else
            echo "Changes detected in requirements.txt"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
            
            echo "Differences:"
            git diff requirements.txt
        fi
        
    - name: ðŸ§ª Test new requirements
      if: steps.check_changes.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      run: |
        echo "Testing new requirements..."
        pip install -r requirements.txt
        
        # Test that key imports work
        python -c "
        import pandas as pd
        import numpy as np
        import requests
        from dotenv import load_dotenv
        print('âœ… Core dependencies working')
        
        try:
            from web3 import Web3
            print('âœ… Web3 working')
        except ImportError as e:
            print(f'âš ï¸ Web3 issue: {e}')
        
        try:
            from google.cloud import bigquery
            print('âœ… BigQuery working')
        except ImportError as e:
            print(f'âš ï¸ BigQuery issue: {e}')
        
        try:
            from supabase import create_client
            print('âœ… Supabase working')  
        except ImportError as e:
            print(f'âš ï¸ Supabase issue: {e}')
        "
        
    - name: ðŸ“ Create Pull Request
      if: steps.check_changes.outputs.changes_detected == 'true' || github.event.inputs.force_update == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: auto-update requirements.txt"
        title: "ðŸ”„ Auto-update requirements.txt"
        body: |
          ## ðŸ¤– Automated Requirements Update
          
          This PR was automatically generated to update `requirements.txt` with newly detected dependencies from the codebase.
          
          ### Changes Made:
          - Scanned all Python files for import statements
          - Added missing third-party dependencies
          - Maintained existing version constraints
          - Tested that core dependencies still work
          
          ### What to Review:
          - [ ] Check that all new dependencies are legitimate
          - [ ] Verify version constraints are appropriate
          - [ ] Test that the application still works with new requirements
          
          **Generated by**: GitHub Actions workflow
          **Trigger**: ${{ github.event_name }}
        branch: auto-update-requirements
        delete-branch: true
        
    - name: ðŸ“Š Summary
      run: |
        echo "## Requirements Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.check_changes.outputs.changes_detected }}" == "true" || "${{ github.event.inputs.force_update }}" == "true" ]]; then
            echo "âœ… **requirements.txt updated and PR created**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A pull request has been created with the updated requirements." >> $GITHUB_STEP_SUMMARY
        else
            echo "â„¹ï¸ **No changes needed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "requirements.txt is already up to date." >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ steps.check_changes.outputs.changes_detected }}" == "true" || "${{ github.event.inputs.force_update }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes Made:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY
            git diff requirements.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi